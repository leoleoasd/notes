\ProvidesPackage{psql}
\RequirePackage{minted}
\RequirePackage{fancyvrb}
\RequirePackage{tcolorbox}
\tcbuselibrary{breakable}
\tcbuselibrary{minted}
\tcbuselibrary{raster}
\tcbuselibrary{skins}

\tcbset{
    snippetraster/.style={
        enhanced,
        raster columns=1,
        raster rows=3,
        raster column skip=0pt,
        raster row skip=-1pt,
        listing only,
        breakable,
        raster row 1/.style={
            sharp corners=south,
            title=SQL code,
            before title=\strut,
            bottomrule=0pt,
        },
        raster row 2/.style={
            % colback=black!20,
            sharp corners=all,
            title=Result on PostgreSQL,
            before title=\strut,
            toprule=0pt,
        },
        raster row 3/.style={
            sharp corners=north,
            title=Result on OpenGauss,
            before title=\strut,
            toprule=0pt,
        },
        % listing options={aboveskip=0pt, belowskip=0pt},
    }
}

\renewcommand{\fcolorbox}[4][]{#4}

\newcounter{sqlcounter}

\def\FVB@run{%
  \@bsphack%
  \begingroup%
    \addtocounter{sqlcounter}{1}
    \FV@UseKeyValues%
    \FV@DefineWhiteSpace%
    \def\FV@Space{\space}%
    \FV@DefineTabOut%
    \def\FV@ProcessLine{\immediate\write\FV@OutFile}%
    \immediate\openout\FV@OutFile sql/temp.sql\relax%
    \ifnum\c@sqlcounter=1
        \immediate\write18{rm sql/diff.lock}
    \fi
    \let\FV@FontScanPrep\relax%
%% DG/SR modification begin - May. 18, 1998 (to avoid problems with ligatures)
    \let\@noligs\relax
%% DG/SR modification end
    \FV@Scan}

\def\FVE@run{\immediate\closeout\FV@OutFile\endgroup\@esphack
    \immediate\write18{bash -c "if [ -f sql/\thesqlcounter.sql ] && ! diff sql/temp.sql sql/\thesqlcounter.sql > \thesqlcounter.diff ; then 
        touch sql/diff.lock;
    fi;
    if [ -f sql/diff.lock ] ; then
        rm sql/*.sql;
        rm sql/*.result;
    fi;
    if [ ! -f sql/diff.lock ] && [ ! -f sql/\thesqlcounter.sql ] ; then
        mv sql/temp.sql sql/\thesqlcounter.sql;
        $(cat gsql.env | xargs) psql -f sql/\thesqlcounter.sql -P format=wrapped -P columns=95 -d \pgdb > sql/\thesqlcounter.gsql.result 2>&1 $(); 
        $(cat psql.env | xargs) psql -f sql/\thesqlcounter.sql -P format=wrapped -P columns=95 -d \pgdb > sql/\thesqlcounter.psql.result 2>&1 $();
    fi;
    "}%
    % \immediate\write18{bash -c ""}% 
\begin{tcbraster}[snippetraster]
    \begin{tcolorbox}[listing file=sql/\thesqlcounter.sql,minted language=postgresql]
        \tcbuselistinglisting
    \end{tcolorbox}
    \begin{tcolorbox}[listing file=sql/\thesqlcounter.psql.result, minted language=text]
        \tcbuselistinglisting
    \end{tcolorbox}
    \begin{tcolorbox}[listing file=sql/\thesqlcounter.gsql.result, minted language=text]
        \tcbuselistinglisting
    \end{tcolorbox}
\end{tcbraster}
}

\DefineVerbatimEnvironment{run}{run}{}

\def\FVB@runsilent{%
  \@bsphack%
  \begingroup%
  \addtocounter{sqlcounter}{1}%
    \FV@UseKeyValues%
    \FV@DefineWhiteSpace%
    \def\FV@Space{\space}%
    \FV@DefineTabOut%
    \def\FV@ProcessLine{\immediate\write\FV@OutFile}%
    \immediate\openout\FV@OutFile sql/temp.sql\relax%
    \let\FV@FontScanPrep\relax%
%% DG/SR modification begin - May. 18, 1998 (to avoid problems with ligatures)
    \let\@noligs\relax
%% DG/SR modification end
    \FV@Scan}

\def\FVE@runsilent{\immediate\closeout\FV@OutFile\endgroup\@esphack
    \immediate\write18{bash -c "if [ -f sql/\thesqlcounter.sql ] && ! diff sql/temp.sql sql/\thesqlcounter.sql > \thesqlcounter.diff ; then 
        touch sql/diff.lock;
    fi;
    if [ -f sql/diff.lock ] ; then
        rm sql/*.sql;
        rm sql/*.result;
    fi;
    if [ ! -f sql/diff.lock ] && [ ! -f sql/\thesqlcounter.sql ] ; then
        mv sql/temp.sql sql/\thesqlcounter.sql;
        $(cat gsql.env | xargs) psql -f sql/\thesqlcounter.sql -P format=wrapped -P columns=95 -d \pgdb > sql/\thesqlcounter.gsql.result 2>&1 $(); 
        $(cat psql.env | xargs) psql -f sql/\thesqlcounter.sql -P format=wrapped -P columns=95 -d \pgdb > sql/\thesqlcounter.psql.result 2>&1 $();
    fi;
    "}%
}

\DefineVerbatimEnvironment{runsilent}{runsilent}{}
